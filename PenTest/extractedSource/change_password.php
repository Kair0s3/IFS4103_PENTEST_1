<?php require_once 'ti.php' ?>
<?php startblock('content') ?>
<?php
include_once("check.php");
if (!isset($_COOKIE["token"]))
{
        exit;
}
if (isset($_POST["newpass"]) and isset($_POST["newpass_verify"]))
{
        if ($_POST["newpass"] == $_POST["newpass_verify"])
        {
                $newpass_hash = addslashes(md5($_POST["newpass"]));
                $token = $_COOKIE["token"];
                $query = "UPDATE users SET password='" . $newpass_hash ."' WHERE token='" . $token . "'";
                $ses_sql = mysqli_query($db, $query);
                $query1 = "SELECT user FROM users WHERE token='" . $token . "'";
                $ses_sql1 = mysqli_query($db, $query1);
                $user = mysqli_fetch_array($ses_sql1,MYSQLI_ASSOC)["user"];
                $new_token = base64_encode($user . ":" . $newpass_hash);
                $query2 = "UPDATE users SET token='" . $new_token ."' WHERE token='" . $token . "'";
                $ses_sql2 = mysqli_query($db, $query2);
                if ($ses_sql and $ses_sql1 and $ses_sql2)
                {
                        echo "Password changed successfully. Please login again.<br>Redirecting in 3 seconds...";
                        echo "<script>setTimeout(function () {window.location.href = 'logout';}, 3000);</script>";
                }
                else
                {
                        echo "Error.<br>Redirecting in 3 seconds...";
                        echo "<script>setTimeout(function () {window.location.href = 'account';}, 3000);</script>";
                }
        }
        else
        {
                echo "Passwords do not match.<br>Redirecting in 3 seconds...";
                echo "<script>setTimeout(function () {window.location.href = 'account';}, 3000);</script>";
        }
}
?>