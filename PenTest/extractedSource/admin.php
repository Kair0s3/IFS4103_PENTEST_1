<?php include 'base.php' ?>
<?php include_once 'config.php' ?>
<?php
if (!isset($_COOKIE["token"]))
{
        header("Location: login");
}
if ($_COOKIE["is_admin"] != 1)
{
        header("Location: index");
}
?>
<?php startblock('style') ?>
<style type="text/css">
        .center {
                margin-left: auto;
                margin-right: auto;
                width: 50%;
                text-align: center;
        }

        .logs-center {
                margin-left: auto;
                margin-right: auto;
                background-color: white;
                width: 85%;
                height: 50vh;
                text-align: center;
        }

        .inner-center {
                margin-left: auto;
                margin-right: auto;
                width: 85%;
                text-align: center;
        }

        input {
                display: inline-block;
                text-align: center;
                color: black;
        }

        th, td {
                padding: 5px;
                text-align: left;
        }

        .my-custom-scrollbar {
                position: relative;
                height: 600px;
                overflow: auto;
        }

        .table-wrapper-scroll-y {
                display: inline-block;
                height: auto;
                width: auto;
        }

        tbody {
                margin-left: auto;
                margin-right: auto;
        }


</style>
<?php endblock() ?>
<?php
function get_row_from_query($query, $db)
{
        $ses_sql = mysqli_query($db, $query);
    $row = mysqli_fetch_array($ses_sql,MYSQLI_ASSOC);
    return $row;
}
function get_rows_from_query($query, $db)
{
        $ses_sql = mysqli_query($db, $query);
    $rows = mysqli_fetch_all($ses_sql,MYSQLI_ASSOC);
    return $rows;
}
?>
<?php startblock('content') ?>
<div class="center navbar-default" style="overflow-x:auto;">
<?php
include("navbar_admin.php");
if (isset($_GET["page"]))
{
        $page = $_GET["page"];
        if ($page == "files")
        {
                // files page
                ?>
                <h1>Files</h1>
                <?php
                if (isset($_POST["filepath"]))
                {
                        $decoded_filepath = base64_decode($_POST["filepath"]);
                        $sftp_server = "ftp://127.0.0.1/";
                        $curl = CURL_PATH;
                        $cmd = $curl . " -k  \"" . $sftp_server . "\" --user \"" . SFTP_USERNAME . ":" . SFTP_PASSWORD . "\" -Q \"-DELE /" . $decoded_filepath . "\""; // Potential command injection but how? It seems that only can blind -> Send out a request as PoC.
                        $dump = "";
                        $rstatus = "";
                        exec($cmd, $dump, $rstatus);
                        if ($rstatus == 0)
                        {
                                $query = "DELETE FROM uploads WHERE filepath='" . $decoded_filepath . "';";
                                $ses_sql = mysqli_query($db, $query);
                                if ($ses_sql)
                                {
                                        echo "<script>alert('File deleted successfully.')</script>";
                                }
                                else
                                {
                                        echo "<script>alert('Error [MySQL]')</script>";
                                }
                        }
                        else
                        {
                                echo "<script>alert('Error [SFTP]')</script>";
                        }

                }
                $query = "SELECT * FROM uploads;";
                $rows = get_rows_from_query($query, $db);
                echo "<h2>Total: " . count($rows) . "</h2>";
                echo "<div class='table-wrapper-scroll-y' my-custom-scrollbar'><table border='1' bordercolor='white' class='table-wrapper-scroll-y my-custom-scrollbar inner-center'>";
                echo "<tr><th><h3 align='center'>id</h3></th><th align='center'><h3 align='center'>filepath</h3></th><th align='center'><h3 align='center'>hash</h3></th><th align='center'><h3 align='center'>Delete File</h3></th></tr>";
                foreach ($rows as $row)
                {
                        echo "<tr>";
                        foreach ($row as $k => $v)
                        {
                                echo "<td><p>$v</p></td>";
                        }
                        echo "<td><form id='delete" . $row["id"] . "' method='post' action='admin?page=files'><input type='hidden' name='filepath' value='" . base64_encode($row["filepath"]) . "'/>";
                        echo "<input type='button' value='Delete' onclick='confirm(\"Are you sure you want to delete this file?\") ? form.submit():void(0)'></form></td>";
                        echo "</tr>";
                }
                echo "</table></div>";
        }
        elseif ($page == "users")
        {
                // users page
                ?>
                <h1>Users</h1>
                <?php
                include("make_admin.php");
                include("create_new_user.php");
                include("delete_user.php");
                $query = "SELECT id,user,is_admin FROM users;";
                $rows = get_rows_from_query($query, $db);
                echo "<table border='1' bordercolor='white' class='inner-center'>";
                echo "<tr><th><h3 align='center'>id</h3></th><th align='center'><h3 align='center'>user</h3></th><th align='center'><h3 align='center'>is_admin</h3></th>";
                echo "<th><h3 align='center'>Make Admin</h3></th><th><h3 align='center'>Delete User</h3></th></tr>";
                foreach ($rows as $row)
                {
                        $last_id = $row["id"];
                        echo "<tr>";
                        foreach ($row as $k => $v)
                        {
                                echo "<td><p>$v</p></td>";
                        }
                        echo "<td><form id='admin" . $row["id"] . "' method='post' action='admin?page=users'><input type='hidden' name='user' value='" . $row["user"] . "'/>";
                        if ($row["is_admin"] == 1)
                        {
                                echo "<input type='hidden' name='make_or_remove' value='remove'><input type='submit' value='Remove Admin'";
                                if ($row["user"] == "admin")
                                {
                                        echo " disabled style='color:grey;'></form></td><td></td>";
                                }
                                else
                                {
                                        echo "></form></td><td><form id='delete" . $row["id"] . "' method='post' action='admin?page=users'><input type='hidden' name='delete_user' value='" . $row["user"] . "'/><input type='submit' value='Delete' disabled></form></td>";
                                }
                        }
                        else
                        {
                                echo "<input type='hidden' name='make_or_remove' value='make'><input type='submit' value='Make Admin'></form></td><td><form id='delete" . $row["id"] . "' method='post' action='admin?page=users'><input type='hidden' name='delete_user' value='" . $row["user"] 
. "'/><input type='submit' value='Delete'></form></td>";
                        }
                        echo "</tr>";
                }
                echo "<tr><form id='new_user_form' method='post' action='admin?page=users'><td><p>" . strval($last_id + 1);
                echo "</p></td><td><p><input type='text' placeholder='New User' name='new_user' required></p>";
                echo "<p><input type='password' placeholder='New Password' name='new_password' required></p></td>";
                echo "<td><select name='new_is_admin' style='color:black;'><option value='0'>0</option><option value='1'>1</option></select></td>";
                echo "<td colspan='2'><input type='submit' value='Create'></td></tr>";
                echo "</table>";
        }
        elseif ($page == "logs")
        {
                // logs page
                ?>
                <h1>Logs</h1>
                <iframe class="logs-center" src="log.php"></iframe>
                <?php
        }
        elseif ($page == "general")
        {
                // general page
                ?>
                <h1>General</h1>
                <table class="inner-center" border="1" bordercolor="white">
                        <tr>
                                <td>
                                        PHP version:
                                </td>
                                <td>
                                        <?php echo phpversion(); ?>
                                </td>
                        </tr>
                        <tr>
                                <td>
                                        MySQL version:
                                </td>
                                <td>
                                        <?php
                                        $query = "SELECT VERSION();";
                                        $rows = get_row_from_query($query, $db);
                                        echo $rows["VERSION()"];
                                        ?>
                                </td>
                        </tr>
                </table>
                <?php
        }
        else
        {
                include($page);
        }
}
else
{
        // general page
        ?>
        <h1>General</h1>
        <table class="inner-center" border="1" bordercolor="white">
                <tr>
                        <td>
                                PHP version:
                        </td>
                        <td>
                                <?php echo phpversion(); ?>
                        </td>
                </tr>
                <tr>
                        <td>
                                MySQL version:
                        </td>
                        <td>
                                <?php
                                $query = "SELECT VERSION();";
                                $rows = get_row_from_query($query, $db);
                                echo $rows["VERSION()"];
                                ?>
                        </td>
                </tr>
        </table>
        <?php
}
?>
<br><br>
</div>

<?php endblock() ?>
<?php startblock('script') ?>
<meta http-equiv="PRAGMA" content="NO-CACHE">
<script type="text/javascript" src="/static/js/jquery.js"></script>
<script type="text/javascript" src="/static/js/bootstrap.js"></script>
<script type="text/javascript" src="/static/js/vue.js"></script>
<script type="text/javascript" src="/static/js/vue-carousel-3d.js"></script>
<script type="text/javascript" src="/static/js/jquery_003.js"></script>
<script type="text/javascript" src="/static/js/jquery_002.js"></script>

<script>

        var vm = new Vue({
                el: '#main-slider',
                data: {
                        slides: 7
                },
                mounted: function () {
                        setTimeout(function () {
                                resizeContent();
                        }, 10);
                },
                components: {
                        'carousel-3d': Carousel3d.Carousel3d,
                        'slide': Carousel3d.Slide
                }
        });

        function removeCarousel() {
                if (isMobile()) {
                        $("#main-slider").hide();
                        $(".util-class").attr('class', 'col-xs-6 col-sm-6 col-md-6 col-lg-6 util-class');
                        $(".footer-bs").attr('class', 'col-xs-6 col-sm-6 col-md-6 col-lg-6 footer-bs');
                        $(".mfooter").css("height", "3vh");
                        $('body').css("font-size", "1vh");
                        $(".utilityImg").css("height", "12vh");
                        $(".utilityImg").css("width", "85vw");
                        $(".utility-caption").css("left", "16px");
                        $('.navbar-nav').find("a").css({
                                "font-size": "17px",
                                "padding": "10px 15px"
                        });
                        $("#utilssip").removeClass("utilityImg");
                        $("#utilssip").css({
                                "background-size": "100% 120px",
                                "box-shadow": "-1px 1px 17px #2facfe, -14px 14px 30px #005691",
                                "border": "1px solid black",
                                "height": "12vh",
                                "width": "85vw"
                        });

                }
        }

        function resizeContent() {
                //***** resize utility container *****
                var viewportHeight = $(window).height();
                var viewportWidth = $(window).width();

                var footerHeight = $('#footer_primary').outerHeight();

                if (viewportWidth > 721) {
                        if (viewportHeight < 600) {
                                $('.carousel-3d-slider').height('250px');
                                $('.carousel-3d-slider > .carousel-3d-slide').height('250px');
                                $('.carousel-3d-slider > .carousel-3d-slide').width('370px');
                        } else {
                                $('.carousel-3d-slider > .carousel-3d-slide').height(0.7 * (viewportHeight - 126 -
                                        footerHeight));
                                $('.carousel-3d-slider').height($('.carousel-3d-slider > .carousel-3d-slide').outerHeight());

                                var carouselSlide_width = 1.512931034482759 * $('.carousel-3d-slider > .carousel-3d-slide')
                                        .outerHeight();

                                $('.carousel-3d-slider > .carousel-3d-slide').width(carouselSlide_width);
                                $('.carousel-3d-slider').width(carouselSlide_width);

                                //$('#carouselSection_placeholder').height( $('#carouselSection').outerHeight() );
                                var carouselHeight = $('.carousel-3d-slider').outerHeight();
                        }
                } else {
                        $('.carousel-3d-slider > .carousel-3d-slide').height('245px');
                        $('.carousel-3d-slider > .carousel-3d-slide').width('370px');
                }

                $('#utilityContainer').height(0.7 * (viewportHeight - carouselHeight - footerHeight - 156));
                $('#utilitySection').height($('.utilityClass').height());
        }

        $('.carousel-3d-controls > .prev > span').html('&lt;');
        $('.carousel-3d-controls > .next > span').html('&gt;');

        $(document).ready(function () {
                navbar_init();
                removeCarousel();
                resizeContent();
                navbar_toggle();
        });
</script>
<?php endblock() ?>